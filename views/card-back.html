<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>T&M Информация</title>
    <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        /* Дополнительные стили для обратной стороны карточки */
        .back-section {
            padding: 8px;
        }

        .tnm-info-block {
            background-color: #F4F5F7;
            border-radius: 3px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .tnm-time-title {
            font-weight: bold;
            margin: 12px 0 8px 0;
            border-bottom: 1px solid #DFE1E6;
            padding-bottom: 4px;
        }

        .tnm-time-entry {
            padding: 8px 0;
            border-bottom: 1px solid #DFE1E6;
            font-size: 13px;
        }

        .tnm-time-header {
            display: flex;
            justify-content: space-between;
        }

        .tnm-time-date {
            color: #5E6C84;
            font-size: 12px;
        }

        .tnm-time-user {
            font-weight: bold;
        }

        .tnm-time-hours {
            color: #0079BF;
            font-weight: bold;
        }

        .tnm-time-description {
            margin-top: 4px;
            font-size: 12px;
            color: #172B4D;
        }

        .tnm-time-total {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-weight: bold;
            border-top: 2px solid #DFE1E6;
            margin-top: 4px;
        }

        .tnm-footer {
            font-size: 11px;
            color: #5E6C84;
            text-align: right;
            margin-top: 12px;
        }

        .tnm-empty-state {
            padding: 12px;
            text-align: center;
            color: #5E6C84;
            font-style: italic;
        }
    </style>
</head>
<body>
<div class="back-section">
    <div class="tnm-time-title">Затраченное время:</div>
    <div id="time-entries-list">
        <div class="tnm-empty-state">Загрузка данных...</div>
    </div>

    <div class="tnm-footer">
        <a href="#" id="open-details">Открыть полную информацию</a>
    </div>
</div>

<script src="../js/storage.js"></script>
<script>
    const t = TrelloPowerUp.iframe();

    // Функция форматирования даты
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString();
    }

    // Загрузка данных при открытии
    document.addEventListener('DOMContentLoaded', function() {
        loadData();

        // Обработчик для открытия детальной информации
        document.getElementById('open-details').addEventListener('click', function(e) {
            e.preventDefault();
            t.popup({
                title: 'T&M Менеджер',
                url: './card-detail.html',
                height: 400
            });
        });
    });

    // Обработка изменений данных
    t.render(function() {
        loadData();
    });

    // Загрузка данных
    function loadData() {
        TnMStorage.getCardData(t)
            .then(function(data) {
                const timeEntriesList = document.getElementById('time-entries-list');

                // Фильтруем только записи о времени
                const timeEntries = data.history ? data.history.filter(entry => entry.type === 'time') : [];

                if (timeEntries.length > 0) {
                    // Сортируем по дате (от новых к старым)
                    timeEntries.sort((a, b) => new Date(b.date) - new Date(a.date));

                    let entriesHTML = '';

                    // Ограничиваем количество записей до 5 для компактности
                    const displayEntries = timeEntries.slice(0, 5);

                    // Отображаем каждую запись
                    displayEntries.forEach(function(entry) {
                        entriesHTML += `
                <div class="tnm-time-entry">
                  <div class="tnm-time-header">
                    <div>
                      <span class="tnm-time-date">${formatDate(entry.date)}</span>
                      <span class="tnm-time-user">${entry.memberName || 'Пользователь'}</span>
                    </div>
                    <div class="tnm-time-hours">${entry.amount} ч</div>
                  </div>
                  ${entry.description ? `<div class="tnm-time-description">${entry.description}</div>` : ''}
                </div>
              `;
                    });

                    // Добавляем информацию о скрытых записях, если они есть
                    if (timeEntries.length > 5) {
                        entriesHTML += `
                <div class="tnm-empty-state">
                  ...и еще ${timeEntries.length - 5} ${getNounPluralForm(timeEntries.length - 5, 'запись', 'записи', 'записей')}
                </div>
              `;
                    }

                    // Добавляем итоговую строку
                    entriesHTML += `
              <div class="tnm-time-total">
                <div>ИТОГО:</div>
                <div>${data.time || 0} ч</div>
              </div>
            `;

                    timeEntriesList.innerHTML = entriesHTML;
                } else {
                    timeEntriesList.innerHTML = '<div class="tnm-empty-state">Записи о затраченном времени отсутствуют</div>';
                }
            })
            .catch(function(err) {
                console.error('Ошибка загрузки данных:', err);
                document.getElementById('time-entries-list').innerHTML =
                    '<div class="tnm-empty-state">Ошибка загрузки данных</div>';
            });
    }

    // Функция для правильного склонения существительных
    function getNounPluralForm(number, one, two, five) {
        let n = Math.abs(number);
        n %= 100;
        if (n >= 5 && n <= 20) {
            return five;
        }
        n %= 10;
        if (n === 1) {
            return one;
        }
        if (n >= 2 && n <= 4) {
            return two;
        }
        return five;
    }
</script>
</body>
</html>